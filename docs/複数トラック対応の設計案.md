# 複数トラック対応の設計案（実装済み）

## 現状

- **歌詞ファイルはプロジェクト1つに1つ**: `MySong_lyrics.txt`
- **編集対象は「今開いている MIDI エディタのテイク」だけ**
- 別トラックの MIDI を開くと、同じ歌詞ファイルを参照してしまう

## 目標

- **トラック（またはテイク）ごとに別の歌詞ファイル**を扱う
- MIDI エディタで別トラックに切り替えたら、**そのトラック用の歌詞を自動で読み込み／表示**

## 方針

### 1. 歌詞ファイルの単位を「プロジェクト」→「テイク（トラック）」にする

- **現在のテイク** = `reaper.MIDIEditor_GetActive()` → `reaper.MIDIEditor_GetTake(editor)`
- テイクを一意に識別するキーでファイル名を決める

**候補:**

| 方式 | ファイル例 | メリット | デメリット |
|------|------------|----------|------------|
| **トラック名** | `MySong_ボーカル_lyrics.txt` | 分かりやすい | 同名トラックで衝突 |
| **トラック番号** | `MySong_Track01_lyrics.txt` | 衝突しない | 番号は並びで変わる |
| **テイク GUID** | `MySong_<GUID>.txt` | 一意で安定 | ファイル名が読みにくい |

**おすすめ**: **トラック名**をサニタイズして使う（`/ \ : * ? " < > |` を `_` に）。同名トラックは「同じファイルを共有」とみなす（必要なら後から番号付与も可）。

### 2. 「テイクが切り替わった」検知

- メインループで毎フレーム `take = reaper.MIDIEditor_GetTake(editor)` を取得
- **前フレームのテイク**と違ったら「切り替え」と判定
  - 現在の `lyric_text` を**いまの `lyrics_file_path`** に保存（未保存変更があれば）
  - 新しいテイク用の `lyrics_file_path` を計算
  - そのファイルを読み込み → `lyric_text` / `lyric_chars` を更新
  - 履歴は**テイクごとに別**にするか、切り替え時にリセットする

### 3. 実装で触る場所

1. **テイク→歌詞ファイルパスを得る関数を追加**
   - 例: `get_lyrics_file_path_for_take(take)`  
     - `take == nil` → 従来どおり 1 ファイル（互換用）
     - トラック名取得: `reaper.GetTrackName(reaper.GetMediaItemTake_Track(take), "")`
     - サニタイズして `ProjectName_トラック名_lyrics.txt` を返す

2. **起動時・グローバルに持つ `lyrics_file_path` をやめる**
   - 「現在のテイク用のパス」を変数で保持（例: `current_lyrics_file_path`）
   - テイク切り替え時にこの変数を更新

3. **メインループ先頭で「テイク切り替え」処理**
   - `last_take` を保持
   - `editor` / `take` を取得し、`take ~= last_take` なら:
     - 現在の歌詞を現在のファイルに保存
     - `current_lyrics_file_path = get_lyrics_file_path_for_take(take)`
     - そのファイルを読み込み、`lyric_text` 等を更新
     - `last_note_signature = nil` など状態をリセット
     - （任意）履歴をテイクごとに分けるか、ここでリセット
   - `last_take = take` を更新

4. **読み書きはすべて `current_lyrics_file_path` を参照**
   - `read_lyrics_file()` / `ensure_lyrics_file()` / 書き込みは、パスを引数で渡すか、現在のパス変数を参照する形に統一

5. **GUI 表示**
   - 「歌詞ファイル:」の表示を、現在の `current_lyrics_file_path`（または「現在のトラック: ボーカル」など）にすると分かりやすい

### 4. 注意点

- **MIDI エディタを閉じているとき**: `take == nil`。このときは「最後に開いていたテイク」のファイルのままにするか、1 ファイルモードにフォールバックするか決める。
- **履歴（Undo/Redo）**: テイク切り替え時に履歴を空にするのが簡単。テイクごとに履歴テーブルを分けると実装は重くなる。
- **初回**: そのトラック用の歌詞ファイルが無ければ、従来どおり自動作成（`ensure_lyrics_file`）でよい。

---

## まとめ

- **「今開いているテイク」＝「そのトラック用の歌詞ファイル」**に対応させる。
- ファイル名を **プロジェクト名 + トラック名（サニタイズ） + `_lyrics.txt`** にし、テイクが切り替わったら保存→別ファイル読み込みで切り替える。
- 既存の「1 プロジェクト 1 ファイル」は、**テイクが取れないときのフォールバック**として残すと互換性が良い。

この方針で実装に落とす場合は、上記の 1～5 の順で変更を加えればよい。
