# ReaperLyricTools

Reaper の MIDI エディタ用に作った **歌詞自動割り当てスクリプト** です。  
アクティブな MIDI テイクのノート数に合わせて、外部 TXT ファイルの歌詞を **1ノート1音節** で自動的に流し込みます。

## 機能概要

- プロジェクトフォルダ内の `ReaperLyricTools_lyrics.txt` を監視し、内容が変わると自動で再読み込み。
- ノート配列（位置・長さ・ピッチ）がしばらく変更されていないタイミングで一括して歌詞を再割り当て。
- 歌詞は **MIDI テキストイベント (type=5 / lyric)** として、各ノート頭に挿入。
- 日本語に対応（UTF-8）し、以下のような処理を行います。
  - 1文字=1コードポイントで安全に分解。
  - 「きょ」「しゃ」「きゃっ」など、**小さい仮名（拗音・促音）を直前の文字に結合して1ノート扱い**。
- ReaScript の `gfx` ウィンドウをドッキング可能な状態で常時表示。
  - 歌詞ファイルのパス表示。
  - 「今ノート編集中かどうか」の状態表示。
  - 「次に挿入される歌詞（最大10ノート分）」のプレビュー。
  - 3つのボタン:
    - **フォルダを開く**: プロジェクトフォルダをファイラで開く（SWS があれば `CF_ShellExecute` を使用）。
    - **挿入 (1行)**: 1行だけ歌詞を入力し、「次に挿入される位置」にユニット単位で挿入（TXT ファイルを書き換え）。
    - **削除 (ノート)**: 次に挿入される位置から指定ノート数分の歌詞ユニットを削除（TXT ファイルを書き換え）。

## 動作環境・依存関係

- Reaper 本体
- ReaScript (Lua) が利用可能であること
- 推奨:
  - **JS_ReaScriptAPI**  
    - `reaper.JS_Mouse_GetState` を使い、マウス左ボタン押下中（ノートドラッグ中）は絶対に歌詞反映を行わないよう制御しています。
  - **SWS Extension**  
    - `CF_ShellExecute` があれば、「フォルダを開く」ボタンでプロジェクトフォルダをファイラで自動オープンできます。

JS_ReaScriptAPI / SWS が無い場合でも、コア機能（歌詞自動割り当て）は動作します。ただし以下の制限があります。

- マウスドラッグ中かどうかを厳密には判定できないため、「ノート編集が落ち着いてから◯秒待つ」ロジックのみで歌詞反映タイミングを制御します。
- 「フォルダを開く」ボタンは、プロジェクトフォルダのパスをダイアログに表示するだけになります。

## インストール方法

1. `ReaperLyricAutofill.lua` を Reaper のスクリプトディレクトリ、または任意の場所に配置。
2. Reaper で  
   `Actions` → `Show action list...` → `ReaScript` タブ → `Load...` から `ReaperLyricAutofill.lua` を読み込む。
3. （任意）JS_ReaScriptAPI と SWS Extension をインストールしておくと、操作感が向上します。

## 使い方

1. Reaper でプロジェクトを保存（RPP を作成）。  
   例: `~/Music/REAPER/Projects/MySong/MySong.rpp`
2. MIDI アイテムを開き、MIDI エディタをアクティブにする。
3. アクションリストから `ReaperLyricAutofill.lua` を実行。
   - 初回実行時に、`ReaperLyricTools_lyrics.txt` が **プロジェクトフォルダ**に自動作成されます。  
     例: `~/Music/REAPER/Projects/MySong/ReaperLyricTools_lyrics.txt`
4. 歌詞ファイルを開いて、好きな日本語歌詞を入力し保存。
   - 1文字ずつノートに入っていきますが、「きょ」「しゃ」などは1ノートとして扱われます。
5. MIDI エディタでノートを配置・編集すると、編集が落ち着いたタイミングで自動的に歌詞がノートに流し込まれます。

### 「挿入 (1行)」ボタン

- 次に入る歌詞を、GUI からちょっと追加したいときに使用します。
- 挙動:
  1. ボタンを押す → 1行入力ダイアログが開く。
  2. 1行で数文字（例: 「きょ」「ゃん」など）を入力。
  3. 現在のアクティブテイクの状態を元に、挿入位置を決定:
     - ノートが選択されていれば → **最後に選択されたノートの「次」**。
     - 何も選択されていなければ → **既存ノートの末尾の「次」**。
  4. その位置に歌詞ユニットを挿入し、`ReaperLyricTools_lyrics.txt` を上書き保存します。

### 「削除 (ノート)」ボタン

- 「この先の数ノート分の歌詞だけまとめて消したい」ときに使用します。
- 挙動:
  1. ボタンを押す → 削除したいノート数を入力（例: `1`〜`10`）。
  2. 挿入と同じルールで **基準位置を決定**し、その「次」から指定ノート数分の歌詞ユニットを削除します。
  3. 反映結果を `ReaperLyricTools_lyrics.txt` に書き戻します。

## 歌詞の割り当てロジック

- 歌詞テキストを UTF-8 で 1コードポイントずつ分解。
- 小さい仮名（拗音・促音など）は直前の文字に結合。
  - 対象文字:  
    `ぁぃぅぇぉゃゅょゎっァィゥェォャュョヮッ`
- これを 1ユニット = 1ノート として、MIDI ノートの先頭に lyric イベントを挿入します。

## 制限事項・注意点

- 歌詞は常に「**アクティブ MIDI テイク**」に対してのみ割り当てられます。
- 一度に処理するノート数が多い場合、歌詞反映のタイミングで少し処理が重く感じることがあります。
  - そのため、「ノート編集中」と判定されている間は反映を行わず、ドラッグ終了＋一定時間後に一括反映する設計にしています。
- `ReaperLyricTools_lyrics.txt` は **UTF-8** を想定しています。他のエンコーディングだと文字化けする可能性があります。

## ライセンス / 改変について

- このスクリプトは個人用ツールとして作成したものですが、自由に改変・再利用してかまいません。
- ただし、自己責任での利用を前提とし、Reaper 本体やプロジェクトファイルへの影響には十分注意してください。

